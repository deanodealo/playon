<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Manager Sign Up - PlayOn</title>
  <link rel="stylesheet" href="index.css" />

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getAuth } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { getFirestore } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyAX9ivQ4aKQzokUMEkNpGTIbbAUMJhLlys",
      authDomain: "playon-1a86b.firebaseapp.com",
      projectId: "playon-1a86b",
      storageBucket: "playon-1a86b.firebasestorage.app",
      messagingSenderId: "28141646391",
      appId: "1:28141646391:web:98d83339ed46c17efa45b2",
      measurementId: "G-Z12HWY8PFJ"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    
    // Make available globally
    window.auth = auth;
    window.db = db;
    window.firebaseReady = true;
    console.log('Firebase initialized successfully');
  </script>
</head>
<body>

<!-- Header -->
<header>
  <button class="burger" aria-label="Menu" onclick="toggleMenu()">
    <span></span>
    <span></span>
    <span></span>
  </button>

  <div class="logo-container">
    <img src="images/logo.png" alt="PlayOn Logo" />
  </div>
</header>

<!-- Overlay -->
<div id="menuOverlay" class="overlay" onclick="closeMenu()"></div>

<!-- Side Menu -->
<nav id="sideMenu" class="side-menu">
  <a href="index.html">Home</a>
  <a href="about.html">About</a>
  <a href="vacancies.html">Vacancies</a>
  <a href="#" onclick="showLogin(event)">Login</a>
  <a href="manager-register.html">Register</a>
  <div class="menu-logo">
    <div class="logo-wrapper">
      <img src="images/logo.png" alt="PlayOn Logo">
    </div>
  </div>
</nav>

<!-- Login Popup Overlay -->
<div id="loginOverlay" class="login-overlay" onclick="closeLogin(event)">
  <div class="login-form-container" onclick="event.stopPropagation()">
    <button class="login-close" onclick="closeLogin()" aria-label="Close">&times;</button>
    
    <!-- Logo in popup -->
    <div class="login-logo">
      <div class="login-logo-wrapper">
        <img src="images/logo.png" alt="PlayOn Logo">
      </div>
    </div>

    <form class="login-form" id="loginForm">
      <h2>Welcome Back</h2>
      
      <label for="loginEmail">Email</label>
      <input type="email" id="loginEmail" required>
      
      <label for="loginPassword">Password</label>
      <input type="password" id="loginPassword" required>
      
      <button type="submit" id="loginBtn">Login</button>
      
      <div class="forgot-password">
        <a href="#" onclick="forgotPassword(event)">Forgot Password?</a>
      </div>
      
      <div id="loginMessage" class="login-message"></div>
      
      <div class="register-link">
        Don't have an account? <a href="manager-register.html">Register here</a>
      </div>
    </form>
  </div>
</div>

<!-- Hero Section for Form -->
<section class="hero register-hero">
  <h1>Manager Sign Up</h1>
  <p>Create your manager account to add vacancies and manage your team.</p>

  <div class="register-form-container">
    <form id="registerForm">
      <label for="managerName">Manager Name</label>
      <input type="text" id="managerName" placeholder="Enter your name" required>

      <label for="teamName">Team</label>
      <select id="teamName" required>
      <option value="">Loading teams...</option>
      </select>

      <label for="location">Location</label>
      <select id="location" required>
      <option value="Stoke On Trent">Stoke on Trent</option>
      <option value="Newcastle under Lyme">Newcastle under Lyme</option>
      <option value="Staffordshire">Staffordshire</option>
      </select>

      <label for="email">Email Address</label>
      <input type="email" id="email" placeholder="you@example.com" required>

      <label for="phone">Mobile Number</label>
      <input type="tel" id="phone" placeholder="07..." required>

      <label for="password">Password</label>
      <input type="password" id="password" placeholder="Minimum 6 characters" required minlength="6">

      <label for="confirmPassword">Confirm Password</label>
      <input type="password" id="confirmPassword" placeholder="Re-enter password" required>

      <button type="submit" id="registerBtn">Register</button>
    </form>
    <div id="registerMessage"></div>
  </div>
</section>

<div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 20px; font-size: 13px; color: #666; text-align: center;">
  <p style="margin: 0;">
    By registering, you consent to your contact details (name, email, phone) being displayed to players viewing your vacancies. 
    Your information is stored securely and will not be shared with third parties. 
    <a href="privacy.html" style="color: #1A2A44; text-decoration: underline;">Privacy Policy</a>
  </p>
</div>

<!-- Footer -->
<footer>
  <p>&copy; 2025 PlayOn. All rights reserved.</p>
  <p>
    <a href="index.html">Home</a> |
    <a href="about.html">About</a> |
    <a href="contact.html">Contact</a> |
    <a href="privacy.html">Privacy</a>
  </p>
</footer>

<script>
  const burger = document.querySelector('.burger');
  const sideMenu = document.getElementById('sideMenu');
  const overlay = document.getElementById('menuOverlay');

  function toggleMenu() {
    const isOpening = !sideMenu.classList.contains('open');

    sideMenu.classList.toggle('open', isOpening);
    overlay.classList.toggle('active', isOpening);
    burger.classList.toggle('open', isOpening);
    document.body.classList.toggle('menu-open', isOpening);
  }

  function closeMenu() {
    sideMenu.classList.remove('open');
    overlay.classList.remove('active');
    burger.classList.remove('open');
    document.body.classList.remove('menu-open');
  }

  // Close menu when a link is clicked
  document.addEventListener('DOMContentLoaded', function () {
    const links = sideMenu.querySelectorAll('a');
    links.forEach(link => link.addEventListener('click', closeMenu));
  });

  // Load teams when page loads
document.addEventListener('DOMContentLoaded', function() {
  loadTeams();
});

async function loadTeams() {
  const teamSelect = document.getElementById('teamName');
  
  try {
    // Wait for Firebase to be ready
    if (!window.firebaseReady) {
      setTimeout(loadTeams, 500);
      return;
    }

    const { collection, getDocs, orderBy, query } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
    
    // Get teams from Firestore
    const teamsQuery = query(collection(window.db, 'teams'), orderBy('name'));
    const querySnapshot = await getDocs(teamsQuery);
    
    // Clear loading option
    teamSelect.innerHTML = '<option value="">Select your team</option>';
    
    // Add teams to dropdown
    querySnapshot.forEach((doc) => {
      const team = doc.data();
      const option = document.createElement('option');
      option.value = team.name;
      option.textContent = team.name;
      teamSelect.appendChild(option);
    });
    
    console.log('Teams loaded successfully');
    
  } catch (error) {
    console.error('Error loading teams:', error);
    
    // Fallback message
    teamSelect.innerHTML = '<option value="">Error loading teams. Please refresh.</option>';
  }
}

  // Firebase Registration Handler
  document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById("registerForm");
    const msg = document.getElementById("registerMessage");
    const registerBtn = document.getElementById("registerBtn");

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      
      // Get form data
      const managerName = document.getElementById("managerName").value.trim();
      const teamName = document.getElementById("teamName").value.trim();
      const location = document.getElementById("location").value.trim();
      const email = document.getElementById("email").value.trim();
      const phone = document.getElementById("phone").value.trim();
      const password = document.getElementById("password").value;
      const confirmPassword = document.getElementById("confirmPassword").value;

      // Validation
      if (password !== confirmPassword) {
        showMessage("Passwords do not match!", "error");
        return;
      }

      if (password.length < 6) {
        showMessage("Password must be at least 6 characters long!", "error");
        return;
      }

      if (!phone.match(/^07\d{9}$/)) {
        showMessage("Please enter a valid UK mobile number (07...)", "error");
        return;
      }

      if (!teamName) {
        showMessage('Please select a team!', 'error');
         return;
      }
      
      // Disable button and show loading
      registerBtn.disabled = true;
      registerBtn.textContent = "Creating Account...";
      showMessage("Creating your account...", "info");

      try {
        // Wait for Firebase to be ready
        if (!window.firebaseReady) {
          throw new Error("Firebase is not ready. Please refresh and try again.");
        }

        // Import Firebase functions
        const { createUserWithEmailAndPassword, updateProfile } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js');
        const { doc, setDoc, serverTimestamp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');

        // Create user account
        const userCredential = await createUserWithEmailAndPassword(window.auth, email, password);
        const user = userCredential.user;

        // Update user profile with display name
        await updateProfile(user, {
          displayName: managerName
        });

        // Save user data to Firestore
        await setDoc(doc(window.db, 'users', user.uid), {
          email: email,
          userType: 'manager',
          createdAt: serverTimestamp()
        });

        // Save manager profile data
        await setDoc(doc(window.db, 'managerProfiles', user.uid), {
          managerName: managerName,
          teamName: teamName,
          location: location,
          phone: phone,
          email: email,
          createdAt: serverTimestamp()
        });

        console.log("User registered successfully:", user.uid);
        showMessage("Account created successfully! Redirecting...", "success");
        
        // Clear form
        form.reset();

        // Redirect to dashboard or home after 2 seconds
        setTimeout(() => {
          window.location.href = "index.html"; // Change to dashboard.html when you create it
        }, 2000);

      } catch (error) {
        console.error("Registration error:", error);
        
        // Handle specific Firebase errors
        let errorMessage = "Registration failed. Please try again.";
        
        switch (error.code) {
          case 'auth/email-already-in-use':
            errorMessage = "This email is already registered. Try logging in instead.";
            break;
          case 'auth/invalid-email':
            errorMessage = "Please enter a valid email address.";
            break;
          case 'auth/weak-password':
            errorMessage = "Password is too weak. Please use at least 6 characters.";
            break;
          case 'auth/network-request-failed':
            errorMessage = "Network error. Please check your connection and try again.";
            break;
          default:
            errorMessage = error.message || errorMessage;
        }
        
        showMessage(errorMessage, "error");
        
      } finally {
        // Re-enable button
        registerBtn.disabled = false;
        registerBtn.textContent = "Register";
      }
    });

    function showMessage(text, type) {
      msg.textContent = text;
      msg.className = type === "success" ? "login-message success" : 
                     type === "error" ? "login-message error" : 
                     "login-message";
      
      // Auto-clear success messages
      if (type === "success") {
        setTimeout(() => {
          msg.textContent = "";
          msg.className = "";
        }, 5000);
      }
    }
  });
</script>

<script src="js/login-popup.js"></script>

</body>
</html>